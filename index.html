<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—éƒ·ã¬ãã‚‚ã‚Šå‘¨éŠäº‹æ¥­</title>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #fdfcf5;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        h1 { color: #8e2c2c; }
        .sub { font-size: 13px; color: #555; }

        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 25px 0;
        }
        .stamp {
            aspect-ratio: 1;
            border: 2px dashed #ccc;
            border-radius: 15px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stamp svg { width: 90%; }

        .card {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #f0cfcf;
        }
        button {
            background: #8e2c2c;
            color: #fff;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 17px;
            width: 100%;
            margin-top: 15px;
        }

        #reward, #camera, #complete { display: none; }
        .big { font-size: 18px; font-weight: bold; color: #8e2c2c; }

        /* ç´™å¹é›ª */
        .confetti {
            position: fixed;
            top: -10px;
            width: 10px;
            height: 10px;
            animation: fall 3s linear infinite;
        }
        @keyframes fall {
            to { transform: translateY(120vh) rotate(360deg); }
        }
    </style>
</head>

<body>

<h1>åŒ—éƒ·ã¬ãã‚‚ã‚Šå‘¨éŠäº‹æ¥­</h1>
<p class="sub">æ—¥å—å¸‚åŒ—éƒ·ç”ºå†…ã®å¯¾è±¡ã‚¹ãƒãƒƒãƒˆã‚’å·¡ã‚‹ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼ã§ã™</p>

<div id="main">

    <div class="stamp-grid">
        <div id="s1" class="stamp"></div>
        <div id="s2" class="stamp"></div>
        <div id="s3" class="stamp"></div>
        <div id="s4" class="stamp"></div>
        <div id="s5" class="stamp"></div>
    </div>

    <div id="reward" class="card">
        <p class="big">ã‚¹ã‚¿ãƒ³ãƒ—å–å¾—å®Œäº†</p>
        <p class="sub">5ã‚¹ãƒãƒƒãƒˆé”æˆã«ã‚ˆã‚Šã€ç‰¹å…¸ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™</p>
        <button onclick="startScan()">ç‰¹å…¸ã‚’åˆ©ç”¨ã™ã‚‹</button>
    </div>

</div>

<div id="camera">
    <p class="big">å—ä»˜ç¢ºèª</p>
    <p class="sub">æ–½è¨­å—ä»˜ã«è¨­ç½®ã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</p>
    <div id="reader"></div>
</div>

<div id="complete" class="card">
    <p class="big">åˆ©ç”¨ç¢ºèªãŒå®Œäº†ã—ã¾ã—ãŸ</p>
    <p class="sub">ã“ã®ç”»é¢ã‚’æ–½è¨­ã‚¹ã‚¿ãƒƒãƒ•ã¸ã”æç¤ºãã ã•ã„</p>
</div>

<script>
/* --- è¨­å®šé …ç›® --- */
const CHECK_CODE = "kitago-cherry-ok"; // ç‰¹å…¸åˆ©ç”¨æ™‚ã®QRã‚³ãƒ¼ãƒ‰å†…å®¹
const GAS_URL = "https://script.google.com/macros/s/AKfycbxQCu4GBCh535iwMA5GCKyVjbQb4fPyR5MhBs2s2Ql0TH90JMAn2qOWmqtwu3r4gOg3NQ/exec"; // GASã®URL

/* --- ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€ä¿¡é–¢æ•° --- */
async function sendLog(action, spot = "-") {
    if (!GAS_URL || GAS_URL.includes("ã“ã“ã«")) return; // URLæœªè¨­å®šæ™‚ã¯å®Ÿè¡Œã—ãªã„
    try {
        await fetch(GAS_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: action, spot: spot })
        });
    } catch (e) {
        console.error("Log Error:", e);
    }
}

/* --- ã‚¹ã‚¿ãƒ³ãƒ—è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ --- */
function stampSVG(type) {
    const icons = { 1:"â›°", 2:"â™¨", 3:"ğŸŒ¸", 4:"ğŸŒŠ", 5:"ğŸ˜" };
    return `
    <svg viewBox="0 0 200 200">
    <circle cx="100" cy="100" r="85" fill="none" stroke="#8e2c2c" stroke-width="10"/>
    <circle cx="100" cy="100" r="65" fill="none" stroke="#8e2c2c" stroke-width="4"/>
    <text x="50%" y="85" text-anchor="middle" font-size="42">${icons[type]}</text>
    <text x="50%" y="130" text-anchor="middle" font-size="18" fill="#8e2c2c">æ—¥å—å¸‚åŒ—éƒ·ç”º</text>
    </svg>`;
}

let stamps = JSON.parse(localStorage.getItem("stamps") || "[]");

function update() {
    stamps.forEach(n => {
        const el = document.getElementById("s"+n);
        if (el && el.innerHTML === "") el.innerHTML = stampSVG(n);
    });
    if (stamps.length >= 5) {
        document.getElementById("reward").style.display = "block";
        confetti();
    }
}

/* --- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ã‚¹ã‚¿ãƒ³ãƒ—å–å¾—åˆ¤å®š --- */
const p = new URLSearchParams(location.search).get("s");
if (p && !stamps.includes(p)) {
    stamps.push(p);
    localStorage.setItem("stamps", JSON.stringify(stamps));
    
    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã€Œå–å¾—ã€ã‚’è¨˜éŒ²
    sendLog("ã‚¹ã‚¿ãƒ³ãƒ—å–å¾—", p);
    
    alert("ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—ã—ã¾ã—ãŸ");
    location.href = location.pathname;
}

/* --- ç´™å¹é›ªæ¼”å‡º --- */
function confetti() {
    for (let i=0;i<40;i++){
        const c = document.createElement("div");
        c.className = "confetti";
        c.style.left = Math.random()*100+"vw";
        c.style.background = ["#e67e8c","#f1c40f","#e74c3c"][Math.floor(Math.random()*3)];
        c.style.animationDuration = (2+Math.random()*2)+"s";
        document.body.appendChild(c);
        setTimeout(()=>c.remove(),4000);
    }
}

/* --- ç‰¹å…¸åˆ©ç”¨ï¼ˆQRã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•ï¼‰ --- */
function startScan() {
    document.getElementById("main").style.display="none";
    document.getElementById("camera").style.display="block";
    const qr = new Html5Qrcode("reader");
    qr.start({facingMode:"environment"},{fps:10,qrbox:250}, async txt=>{
        if(txt===CHECK_CODE){
            qr.stop();
            
            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã€Œåˆ©ç”¨å®Œäº†ã€ã‚’è¨˜éŒ²
            await sendLog("ç‰¹å…¸åˆ©ç”¨å®Œäº†", "ã‚µãƒ³ãƒã‚§ãƒªãƒ¼åŒ—éƒ·");
            
            localStorage.removeItem("stamps");
            document.getElementById("camera").style.display="none";
            document.getElementById("complete").style.display="block";
        }
    });
}

update();
</script>

</body>
</html>